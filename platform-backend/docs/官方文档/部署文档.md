# 1. 本地启动

## 1.1 本地引擎

### 1. 引擎介绍

测试引擎由python语言开发，API测试使用requests进行接口请求，WEB测试使用Selenium进行浏览器驱动，APP测试使用Uiautomator2和Facebook-wda进行手机驱动。

平台将测试引擎独立出来的主要目的就是让测试执行更加灵活，不再受限于资源、网络等限制。比如有些软件系统需要在交付现场进行交付测试，传统方法要么手工测试，要么做了自动化测试但现场重新搭建测试执行依赖环境耗时过久。而本平台执行测试只需要在客户现场启动一个注册引擎，即可执行对应的自动化测试用例。

同时，常见的接口测试平台很多受限于执行资源紧张，遇到用户执行并发较大时，测试执行只能等待。此时解决办法往往只能加服务器资源，而大多数时候其实用不了太多资源，从而造成资源浪费。但当我们把测试引擎变成注册制时，问题迎刃而解，用户只需要简单配置即可获取自己的执行资源，不再需要与别人抢资源。

### 2. 引擎启动

测试引擎支持在Windows、Mac、Linux上运行。引擎代码：[GitHub地址](https://github.com/Chras-fu/Liuma-engine)。
注：企业版引擎代码从下载包中获取。

依赖环境：Python3.8，Chrome，Git

```
1. 拉取代码: git clone https://github.com/Chras-fu/LiuMa-engine.git
2、切换目录：cd LiuMa-engine
3、安装依赖：pip3 install -r requirements.txt
4、获取平台注册的引擎code和secret，填写在/config/config.ini 文件对应字段
5、下载Chromedriver，查看自己chrome版本，根据版本下载对应的驱动。
6、将下载的Chromedriver放在/browser 目录下。linux需要修改/config/config.ini文件 [Webdriver][options]字段为：normal
7、启动引擎：python3 startup.py
8、平台查看引擎状态显示在线，启动成功。如果仍为离线，查看/log/engine_status.log 文件的具体错误信息，一般是网络问题或者引擎code和secret填写错误。
```

注：Chromedriver下载地址：[链接](https://registry.npmmirror.com/binary.html?path=chromedriver/)

## 1.2 本地代理

### 1. 代理介绍

设备代理主要用来挂载手机设备，从而供应平台APP测试执行的需要。主要使用python语言进行开发。

设备代理与测试引擎不同，对所在网络要求严格。如果测试平台属于公司内部使用，一般建议将设备代理挂载在公司内网，并将负载机的20000-40000的端口以及3500和3600端口开放出来，此时公司内网的所有用户均可使用该设备群。此外，测试引擎执行测试时也需要访问设备，因此测试引擎也必须在内网部署才能使用。

另外一种办法就是挂载设备的电脑或服务器拥有公网ip或者进行公网ip的转发，此时无论用户或者引擎在什么网络下均不影响使用。但公网带宽不足时会影响使用体验和测试执行效率。

总而言之，如果内网部署设备，那么引擎必须同属内网。如果公网部署设备，则没有任何限制。而测试平台在公网或者内网不受任何影响。

### 1. 代理启动

设备代理支持在Windows、Mac、Linux上运行。代理代码：[GitHub地址](https://github.com/Chras-fu/Liuma-agent)。
注：企业版代理代码从下载包中获取。

依赖环境：Python3.8，adb，iTunes(windows)，Git

```
1. 拉取代码: git clone https://github.com/Chras-fu/Liuma-agent.git
2. 切换目录：cd Liuma-agent
3. 安装python依赖：pip3 install -r requirements.txt
4. 修改/config/config.ini文件中Platform->url为后端地址
5. 修改/config/config.ini文件中Provider->host为本机IP
6. 修改/config/config.ini文件中StartParam是否启用安卓/苹果设备挂载
7. 如挂载苹果设备 win电脑需要安装iTunes 且手机预安装WDA并填写wda-bundle-id
8. owner填写平台用户账号和project填写项目名 默认system为所有项目所有人共享设备
9. 电脑usb连接手机后 启动代理 python3 startup.py
```

# 2. 容器部署

平台和引擎支持容器部署，设备代理项目由于需要通过USB连接手机，容器部署意义不大，因此暂不支持，本地启动即可。

## 2.1 环境准备

### 1. 配置要求

管理平台服务器要求：2C4G CentOS

测试引擎服务器要求：2C4G CentOS

注：测试引擎服务器主要用来启动系统引擎，也可以不需要，全部使用用户注册引擎执行测试也可以。注册引擎启动在用户PC上，不占用服务器资源。

## 2.2 项目部署

### 1. 平台部署

```
1. 安装docker并更换镜像源，参考下方链接
2. 安装docker-compose: yum install -y docker-compose。
3. 安装后验证：docker-compose --version
4. 下载流马release包并上传服务器(下载链接)，解压后进入到docker_deploy目录（企业版上传解压后的platform文件夹，并进入到platform目录）
5. 修改/springboot/application.properties文件中的七牛云存储与邮件服务的配置信息(参考常见问题)。此步可以省略，但邮件通知服务无法使用，云存储默认为本地存储。
6. 先停止所有容器命令：docker-compose rm -s -f
7. 启动所有容器命令：docker-compose up -d
8. 查看启动结果命令：docker ps (见下图)
```

![3-2-1](http://www.liumatest.cn/community/editor-md-upload/3-2-1.png)

注：docker安装教程:[链接](https://www.jb51.net/article/241288.htm)

最后验证部署结果：浏览器打开：http://服务器ip:80，成功打开登录页，输入管理员(LMadmin/Liuma@123456)或演示用户(demo/123456)账号进行登录，登录成功，证明已经部署成功。

### 2. 引擎部署

引擎Docker部署包含2部分: python服务 + WEBUI自动化运行环境。需要先进行运行环境部署，再部署python服务。

部署前先安装docker并更换镜像源，参考平台部署第一步。

（一）zelenium环境部署

```
1. 拉取selenium镜像命令：docker pull elgalu/selenium
2. 拉取zelenium镜像命令：docker pull quillo/zalenium
3. 启动容器命令：docker run --rm -ti -d --name zalenium -p 4444:4444 -e PULL_SELENIUM_IMAGE=true -v /var/run/docker.sock:/var/run/docker.sock -v /media1/data/zalenium_data:/home/seluser/videos --privileged quillo/zalenium start --desiredContainers 2 --maxTestSessions 1 --maxDockerSeleniumContainers 10 --videoRecordingEnabled false
```

参数说明：

```
--desiredContainers 2               一次性启动几个node节点
--maxTestSessions 1                 每个节点最大可创建的session数量
--maxDockerSeleniumContainers       最大可同时运行的container数量
```


（二）python项目部署



```
1. 下载引擎release包并上传服务器(下载链接)，解压后进入到liuma-engine目录（企业版上传解压后的engine文件夹，并进入到engine目录）
2. 构建镜像：docker build -t engine:1.0 . （engine:1.0 是自定义的名字，格式为： 名称:版本号，不要遗漏后面的点）
3. 获取平台url，填写在/config/config.ini文件[Platform][url]中，参考下图
4. 使用系统管理员用户登录平台->引擎管理页面获取系统引擎的code和secret，填写在/config/config.ini文件[Engine]中，参考下图
4. 获取zelenium所在服务器的ip，并配置/config/config.ini文件[WebDriver]中，参考下图
5. 启动容器命令：docker run -it -v /你的引擎代码绝对路径/config:/liuma/config -v /你的引擎代码绝对路径/log:/liuma/log -d engine:1.0
6. 平台引擎管理处查看引擎是否在线。
7. 其他三个系统引擎请重复3-6步。
```

![3-2-2](http://www.liumatest.cn/community/editor-md-upload/3-2-2.png)

## 2.3 项目升级

项目升级前请先做好备份工作，将平台部署所在文件夹进行打包备份。确保数据不会丢失。

### 1. 平台升级

当官方发布新版本时，先将新的部署包下载到本地，社区版下载release包，企业版下载新版本docker包。

```
1. 将/平台部署包/springboot目录替换原有的springboot目录。
2. 复制原有的application.properties文件中关于七牛云和文件存储配置(未配置忽略)。
3. 将/平台部署包/nginx/data/dist目录替换原有的dist目录。
4. mysql目录不要进行更改替换。
5. 切换到docker-compose.yml所在目录
6. 关闭现有容器: docker-compose rm -s -f
7. 重启所有容器: docker-compose up -d
8. 查看启动结果命令：docker ps (结果与2.2.1一致)
```

### 2. 引擎升级

引擎升级无须再次安装zelenium容器，仅重新制作引擎的容器镜像，并重启引擎。

```
1. 上传引擎代码。
2. 关闭现有所有引擎容器。
3. 部署方式与初次安装一致。见2.2.2
```

# 3. 常见问题

1.如何配置邮件服务?

```
邮件服务主要用于计划执行完成后发送通知，支持各类SMTP协议的邮箱，以163邮箱为例：
配置步骤:
第一步: 登录163邮箱，在设置中开启SMTP服务，保存秘钥token
第二步: 获取邮箱SMTP服务地址: smtp.163.com、邮箱地址、秘钥token
第三步: 配置文件打开邮件服务开关，将以上信息填写在文件~/application.properties对应位置
注：如不需使用，可以将开关关闭。计划执行完成后不再发送邮件通知。同时，企业版新建用户和重置密码时不会发送邮件，默认密码为12345678。
```

2.如何配置七牛云存储？

```
主要用于存放WEB/APP测试执行过程截图，配置如下：
配置步骤:
第一步: 注册七牛云账号 开通空间存储服务
第二步: 创建存储空间bucket 获取ak/sk信息 同时获取加速域名(可以先试用测试域名 后期配置自定义域名)
第三步: 配置文件打开云存储开关，将以上信息填写在文件application.properties对应位置
注: 七牛云存储每个用户有10G免费空间容量，超过则需要计费(价格不贵，50G几十块钱一年)，如果不愿意使用可以关闭云存储开关在服务器上保存。
```

3.java容器启动失败？

```
/docker_deploy/springboot/start_server.sh文件可能会出现格式问题，如果部署失败，请按下图步骤确认。   
```

![3-3-1](http://www.liumatest.cn/community/editor-md-upload/3-3-1.png)

4.首页看板没有数据，后端报错？

```
这个问题主要由于mysql5.7以上默认开启ONLY_FULL_GROUP_BY的配置，这个配置使得统计SQL无法执行产生报错。
```

解决办法参考[教程链接](https://www.cnblogs.com/jaxyoun/p/13177993.html)

5.Linux下安装引擎psycopg2依赖报错?

```
在 Linux 系统下，直接使用 pip 安装 psycopg2 会安装不成功。
因为 pip 只是安装了 PostgreSQL 的 python 接口，其底层还需要调用 PostgreSQL 的 C 语言库。
而这个 C语言 库在 Linux 系统上还需要另外用系统包管理器进行安装。
```

解决办法参考[教程链接](https://blog.csdn.net/u010280923/article/details/120257671)