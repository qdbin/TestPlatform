# 测试自动化平台后端 - 系统功能结构图

## 系统整体架构图

```mermaid
graph TB
    subgraph "前端界面层"
        UI[Web前端界面]
        MOBILE[移动端界面]
    end
    
    subgraph "API网关层"
        GATEWAY[API网关]
        AUTH[权限认证]
        CORS[跨域处理]
    end
    
    subgraph "业务服务层"
        subgraph "核心功能模块"
            USER[用户管理 UserService]
            PROJECT[项目管理 ProjectService]
            PERMISSION[权限管理 PermissionService]
            ROLE[角色管理 RoleService]
        end
        
        subgraph "测试管理模块"
            CASE[用例管理 CaseService]
            API[接口管理 ApiService]
            COLLECTION[集合管理 CollectionService]
            PLAN[计划管理 PlanService]
            RUN[执行管理 RunService]
        end
        
        subgraph "资源管理模块"
            ENVIRONMENT[环境管理 EnvironmentService]
            DATABASE[数据库管理 DatabaseService]
            ELEMENT[元素管理 ElementService]
            CONTROL[控件管理 ControlService]
            DRIVER[驱动管理 DriverService]
        end
        
        subgraph "报告统计模块"
            REPORT[报告管理 ReportService]
            STATISTICS[统计服务 StatisticsService]
            NOTIFICATION[通知服务 NotificationService]
        end
        
        subgraph "设备引擎模块"
            DEVICE[设备管理 DeviceService]
            ENGINE[引擎管理 EngineService]
            WEBSOCKET[WebSocket服务 WebSocketHandler]
        end
    end
    
    subgraph "数据访问层"
        MYBATIS[MyBatis ORM框架]
        MAPPER[Mapper接口层]
        DOMAIN[实体对象层]
    end
    
    subgraph "数据存储层"
        MYSQL[(MySQL数据库)]
        REDIS[(Redis缓存)]
        OSS[(对象存储OSS)]
    end
    
    UI --> GATEWAY
    MOBILE --> GATEWAY
    GATEWAY --> AUTH
    AUTH --> USER
    AUTH --> PERMISSION
    
    USER --> MYBATIS
    PROJECT --> MYBATIS
    CASE --> MYBATIS
    API --> MYBATIS
    PLAN --> MYBATIS
    REPORT --> MYBATIS
    DEVICE --> MYBATIS
    ENGINE --> MYBATIS
    
    MYBATIS --> MAPPER
    MAPPER --> DOMAIN
    MAPPER --> MYSQL
    
    RUN --> WEBSOCKET
    ENGINE --> WEBSOCKET
    WEBSOCKET --> DEVICE
    
    REPORT --> OSS
    STATISTICS --> REDIS
```

## 核心功能模块详细结构图

### 1. 用户权限管理模块

```mermaid
graph LR
    subgraph "用户管理"
        A[用户注册] --> B[账号唯一性校验]
        B --> C[手机号唯一性校验]
        C --> D[创建用户]
        D --> E[分配默认项目]
        E --> F[分配默认角色]
        
        G[用户登录] --> H[账号密码验证]
        H --> I[生成JWT Token]
        I --> J[返回用户信息]
        
        K[用户管理] --> L[用户信息修改]
        K --> M[密码修改]
        K --> N[项目切换]
        K --> O[权限查询]
    end
    
    subgraph "权限控制"
        P[RBAC权限模型] --> Q[用户-角色关联]
        Q --> R[角色-权限关联]
        R --> S[权限验证]
        
        T[项目权限] --> U[用户-项目关联]
        U --> V[项目级权限控制]
        V --> W[数据隔离]
    end
```

### 2. 测试用例管理模块

```mermaid
graph TD
    subgraph "用例类型支持"
        A[API用例] --> B[HTTP请求配置]
        A --> C[断言设置]
        A --> D[参数提取]
        
        E[WEB用例] --> F[页面元素操作]
        E --> G[浏览器驱动]
        E --> H[截图记录]
        
        I[APP用例] --> J[移动端控件操作]
        I --> K[设备连接]
        I --> L[应用安装]
    end
    
    subgraph "用例生命周期"
        M[用例创建] --> N[基本信息设置]
        N --> O[步骤配置]
        O --> P[断言定义]
        P --> Q[参数定义]
        
        R[用例执行] --> S[环境准备]
        S --> T[步骤执行]
        T --> U[结果验证]
        U --> V[资源清理]
        
        W[用例管理] --> X[版本控制]
        X --> Y[复制重用]
        Y --> Z[批量操作]
    end
```

### 3. 测试计划与执行模块

```mermaid
graph TB
    subgraph "计划管理"
        A[计划创建] --> B[选择测试集合]
        B --> C[设置执行环境]
        C --> D[配置调度策略]
        D --> E[设置通知方式]
        
        F[调度策略] --> G[一次性执行]
        F --> H[周期性执行]
        H --> I[按小时/天/周/月]
        
        J[环境配置] --> K[选择测试环境]
        K --> L[配置环境参数]
        L --> M[环境可用性检查]
    end
    
    subgraph "执行流程"
        N[任务接收] --> O[数据下载]
        O --> P[测试数据解析]
        P --> Q[执行计划生成]
        Q --> R[并发线程分配]
        R --> S[用例执行]
        S --> T[结果收集]
        T --> U[报告生成]
        U --> V[结果上传]
        
        W[并发控制] --> X[最大并发数限制]
        X --> Y[线程池管理]
        Y --> Z[资源监控]
    end
```

## 数据流转图

### 1. 请求处理流程

```mermaid
sequenceDiagram
    participant Client as 客户端
    participant Gateway as API网关
    participant Auth as 权限认证
    participant Controller as 控制器
    participant Service as 业务服务
    participant Mapper as 数据访问
    participant DB as 数据库
    
    Client->>Gateway: HTTP请求
    Gateway->>Auth: 权限验证
    Auth->>Auth: JWT Token验证
    Auth->>Gateway: 验证结果
    Gateway->>Controller: 转发请求
    Controller->>Service: 调用业务逻辑
    Service->>Service: 业务规则处理
    Service->>Mapper: 数据操作请求
    Mapper->>DB: SQL执行
    DB->>Mapper: 返回数据
    Mapper->>Service: 数据对象
    Service->>Controller: 业务结果
    Controller->>Gateway: 响应数据
    Gateway->>Client: HTTP响应
```

### 2. 测试执行数据流

```mermaid
graph LR
    subgraph "数据准备阶段"
        A[测试计划] --> B[选择测试集合]
        B --> C[获取用例列表]
        C --> D[下载测试数据]
        D --> E[解析测试配置]
    end
    
    subgraph "执行阶段"
        E --> F[创建执行任务]
        F --> G[分配执行引擎]
        G --> H[并发执行用例]
        H --> I[实时收集结果]
        I --> J[异常处理]
    end
    
    subgraph "结果阶段"
        J --> K[生成测试报告]
        K --> L[上传截图日志]
        L --> M[更新执行状态]
        M --> N[发送通知消息]
    end
```

## 业务流程图

### 1. 用例执行完整流程

```mermaid
flowchart TD
    Start([开始]) --> CheckAuth{权限检查}
    CheckAuth -->|通过| LoadEnv[加载环境配置]
    CheckAuth -->|拒绝| EndAuth[返回权限错误]
    
    LoadEnv --> InitDriver[初始化驱动]
    InitDriver -->|成功| ExecuteSteps[执行测试步骤]
    InitDriver -->|失败| HandleInitError[处理初始化错误]
    
    ExecuteSteps --> StepLoop{还有步骤?}
    StepLoop -->|是| ExecuteStep[执行单个步骤]
    ExecuteStep --> ValidateResult[验证结果]
    ValidateResult -->|成功| RecordSuccess[记录成功]
    ValidateResult -->|失败| RecordFailure[记录失败]
    RecordSuccess --> StepLoop
    RecordFailure --> StepLoop
    
    StepLoop -->|否| GenerateReport[生成测试报告]
    GenerateReport --> Cleanup[资源清理]
    Cleanup --> UploadResult[上传执行结果]
    UploadResult --> End([结束])
    
    HandleInitError --> GenerateReport
    EndAuth --> EndError([结束])
```

### 2. 计划调度执行流程

```mermaid
flowchart LR
    A[定时任务触发] --> B[查询待执行计划]
    B --> C{计划状态检查}
    C -->|正常| D[获取计划配置]
    C -->|异常| E[记录异常状态]
    
    D --> F[检查环境可用性]
    F -->|可用| G[创建执行任务]
    F -->|不可用| H[发送环境异常通知]
    
    G --> I[选择执行引擎]
    I --> J[发送执行任务]
    J --> K[监控执行状态]
    
    K --> L{执行完成?}
    L -->|是| M[收集执行结果]
    L -->|否| N[继续监控]
    
    M --> O[更新计划状态]
    O --> P[计算下次执行时间]
    P --> Q[更新调度信息]
    Q --> R[发送执行通知]
```

## 技术架构说明

### 1. 架构设计原则

**分层架构模式**
- 表现层：RESTful API接口设计
- 业务层：Service层封装业务逻辑
- 数据层：MyBatis ORM框架 + MySQL数据库
- 接口层：WebSocket实时通信

**微服务设计理念**
- 模块化设计，高内聚低耦合
- 服务间通过接口解耦
- 支持水平扩展和负载均衡
- 故障隔离和容错处理

### 2. 核心技术栈

**后端框架**
- Spring Boot 2.x：快速开发框架
- Spring MVC：RESTful API支持
- MyBatis 3.x：ORM数据访问框架
- Spring Transaction：声明式事务管理

**数据存储**
- MySQL 8.0：关系型数据存储
- Redis：缓存和会话管理
- OSS：对象存储（报告截图等）

**安全认证**
- JWT Token：无状态身份认证
- Spring Security：安全框架集成
- RBAC权限模型：基于角色的访问控制

**通信机制**
- HTTP/HTTPS：API接口通信
- WebSocket：实时双向通信
- RESTful：资源导向的API设计

### 3. 性能优化策略

**数据库优化**
- 索引优化：关键字段建立索引
- 查询优化：避免N+1查询问题
- 连接池：数据库连接复用
- 读写分离：主从数据库架构

**缓存策略**
- 用户会话缓存
- 权限数据缓存
- 热点数据缓存
- 查询结果缓存

**并发处理**
- 线程池管理
- 异步任务处理
- 分布式锁机制
- 乐观锁并发控制

### 4. 可靠性保障

**容错机制**
- 服务降级处理
- 熔断器模式
- 重试机制
- 异常日志记录

**监控告警**
- 系统性能监控
- 业务指标监控
- 异常告警机制
- 健康检查接口

**数据安全**
- 数据加密存储
- SQL注入防护
- XSS攻击防护
- 敏感信息脱敏